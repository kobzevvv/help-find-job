name: Auto Fix PR Issues

on:
  pull_request_target:
    types: [opened, synchronize]
    branches: [ main, develop ]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-fix:
    name: Auto Fix Code Quality Issues
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Setup Husky
      run: npm run prepare

    - name: Auto-fix ESLint issues
      run: npm run lint:fix

    - name: Auto-format code
      run: npm run format

    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Commit auto-fixes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add -A
        git commit -m "ðŸ¤– Auto-fix: Code quality improvements

- Fixed ESLint issues
- Applied Prettier formatting
- Auto-generated by CI pipeline"

    - name: Push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: git push

    - name: Comment on PR
      if: steps.verify-changed-files.outputs.changed == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '## âœ… Auto-Fixed Code Quality Issues\n\nI\'ve automatically fixed the following issues in your PR:\n\n- ðŸ”§ **ESLint issues** - Applied automatic fixes\n- ðŸŽ¨ **Code formatting** - Applied Prettier formatting\n\nThe changes have been committed to your branch. Please review them and ensure they look correct before merging.\n\n### What was changed:\n- Fixed linting errors and warnings\n- Applied consistent code formatting\n- Maintained code functionality\n\nðŸ“– Need help understanding the changes? Check our [Code Quality Guide](./docs/CODE_QUALITY_GUIDE.md)'
          });
